// Declarative Pipeline for CI/CD (Freestyle Job) - JavaScript Version
// This pipeline is designed for Freestyle Jenkins jobs using JavaScript/Node.js.
// It includes build, test, and artifact archiving stages.
pipeline {
    agent any
    // Pipeline options: Configure build behavior
    options {
        // Add timestamps to console output
        timestamps()
        // Show colored output in console logs
        ansiColor('xterm')
        // Used to limit the build time and manage build history
        timeout(time: 60, unit: 'MINUTES')
        // How many builds to keep & how long to keep them
        buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
    }
    // Parameters for user input in Freestyle jobs
    parameters {
        // Branch parameter to specify which branch to build
        string(name: 'BRANCH', defaultValue: 'master', description: 'Branch to build')
        // Boolean parameter to decide which tests to run
        booleanParam(name: 'RUN_SANITY_TESTS', defaultValue: true, description: 'Run sanity tests')
        booleanParam(name: 'RUN_SMOKE_TESTS', defaultValue: false, description: 'Run smoke tests')
        booleanParam(name: 'RUN_REGRESSION_TESTS', defaultValue: false, description: 'Run regression tests')
        booleanParam(name: 'RUN_INTEGRATION_TESTS', defaultValue: false, description: 'Run integration tests')
    }
    stages {
        // Checkout stage: This stage checks out the code from the specified branch
        stage('Checkout') {
            steps {
                script {
                    // Checkout stage: Fetch and checkout the specified branch
                    checkout([$class: 'GitSCM', branches: [[name: "*/${params.BRANCH}"]], userRemoteConfigs: [[url: 'https://github.com/your-repo.git']]])  // Replace with actual repo URL
                }
            }
        }

        // Build stage: Install dependencies and build the project
        stage('Build') {
            steps {
                nodejs(nodeJSInstallationName: 'node') {
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }

        // Unit Tests stage: Run unit tests and publish results
        stage('Unit Tests') {
            steps {
                nodejs(nodeJSInstallationName: 'node') {
                    sh 'npm test'
                }
            }
            post {
                // Always publish JUnit test results (assuming jest-junit or similar is configured)
                always { junit 'test-results/**/*.xml' }
            }
        }

        // Sanity Tests stage: Run sanity tests if enabled
        stage('Sanity Tests') {
            when { expression { return params.RUN_SANITY_TESTS } }
            steps {
                nodejs(nodeJSInstallationName: 'node') {
                    sh 'npm run sanity'  // Assuming you have this script
                }
            }
            post {
                always { junit 'test-results/sanity/**/*.xml' }
            }
        }

        // Archive stage: Archive build artifacts for later use
        stage('Archive') {
            steps { archiveArtifacts artifacts: 'dist/**/*,build/**/*', fingerprint: true }
        }
    }
    // Post-build actions: Run based on build result
    post {
        success { echo "Build succeeded: ${env.BUILD_URL}" }
        unstable { echo "Build unstable: ${env.BUILD_URL}" }
        failure { echo "Build failed: ${env.BUILD_URL}" }
        always { cleanWs() }
    }
}